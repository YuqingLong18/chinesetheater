generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = "postgresql://chinesetheater:W1H5ULol@localhost:5432/chinesetheater"
}

enum SenderType {
  student
  ai
}

enum ImageActionType {
  generation
  edit
}

enum SpacetimeAnalysisType {
  crossCulture
  sameEra
  sameGenre
  custom
}

enum WorkshopMode {
  relay
  adaptation
}

enum WorkshopStatus {
  active
  completed
  archived
}

enum WorkshopMemberRole {
  teacher
  student
}

enum WorkshopContributionStatus {
  accepted
  pending
  retracted
}

enum WorkshopChatType {
  message
  system
}

enum WorkshopVoteType {
  keep
  rewrite
}

model Teacher {
  teacherId    Int       @id @default(autoincrement())
  username     String    @unique
  passwordHash String
  createdAt    DateTime  @default(now())
  sessions     Session[]
}

model Session {
  sessionId       Int              @id @default(autoincrement())
  teacher         Teacher          @relation(fields: [teacherId], references: [teacherId], onDelete: Cascade)
  teacherId       Int
  sessionName     String
  sessionPin      String           @unique
  authorName      String
  literatureTitle String
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  students        Student[]
  conversations   Conversation[]
  images          GeneratedImage[]
  imageActivities ImageActivity[]
  spacetimeAnalyses SpacetimeAnalysis[]
}


model Student {
  studentId      Int              @id @default(autoincrement())
  session        Session          @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)
  sessionId      Int
  username       String
  passwordHash   String
  initialPassword String?
  isUsed         Boolean          @default(false)
  firstLoginAt   DateTime?
  lastActivityAt DateTime?
  conversations  Conversation[]
  messages       Message[]
  images         GeneratedImage[]
  imageActivities ImageActivity[]
  spacetimeAnalyses SpacetimeAnalysis[]

  @@unique([sessionId, username])
}

model Conversation {
  conversationId Int       @id @default(autoincrement())
  student        Student   @relation(fields: [studentId], references: [studentId], onDelete: Cascade)
  studentId      Int
  session        Session   @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)
  sessionId      Int
  messageCount   Int       @default(0)
  totalDuration  Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  messages       Message[]

  @@unique([studentId, sessionId])
}

model Message {
  messageId      Int          @id @default(autoincrement())
  conversation   Conversation @relation(fields: [conversationId], references: [conversationId], onDelete: Cascade)
  conversationId Int
  student        Student?     @relation(fields: [studentId], references: [studentId], onDelete: SetNull)
  studentId      Int?
  senderType     SenderType
  content        String
  timestamp      DateTime     @default(now())
}

model GeneratedImage {
  imageId          Int      @id @default(autoincrement())
  student          Student  @relation(fields: [studentId], references: [studentId], onDelete: Cascade)
  studentId        Int
  session          Session  @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)
  sessionId        Int
  style            String
  sceneDescription String
  imageUrl         String
  editCount        Int      @default(0)
  isShared         Boolean  @default(false)
  createdAt        DateTime @default(now())
  activities       ImageActivity[]
}

model ImageActivity {
  activityId  Int              @id @default(autoincrement())
  image       GeneratedImage   @relation(fields: [imageId], references: [imageId], onDelete: Cascade)
  imageId     Int
  student     Student          @relation(fields: [studentId], references: [studentId], onDelete: Cascade)
  studentId   Int
  session     Session          @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)
  sessionId   Int
  actionType  ImageActionType
  instruction String
  createdAt   DateTime         @default(now())
}

model SpacetimeAnalysis {
  analysisId      Int                     @id @default(autoincrement())
  student         Student                 @relation(fields: [studentId], references: [studentId], onDelete: Cascade)
  studentId       Int
  session         Session                 @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)
  sessionId       Int
  author          String
  workTitle       String
  era             String
  genre           String
  analysisType    SpacetimeAnalysisType
  focusScope      String?
  promptNotes     String?
  customInstruction String?
  generatedContent String
  createdAt        DateTime                @default(now())
}

model WorkshopRoom {
  roomId             Int                   @id @default(autoincrement())
  code               String                @unique
  title              String
  mode               WorkshopMode
  theme              String?
  originalTitle      String?
  originalContent    String?
  meterRequirement   String?
  maxParticipants    Int
  targetLines        Int?
  status             WorkshopStatus        @default(active)
  currentTurnOrder   Int?
  timeLimitMinutes   Int?
  creatorTeacherId   Int?
  creatorStudentId   Int?
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  members            WorkshopMember[]
  contributions      WorkshopContribution[]
  chats              WorkshopChatMessage[]
}

model WorkshopMember {
  memberId   Int                 @id @default(autoincrement())
  roomId     Int
  room       WorkshopRoom        @relation(fields: [roomId], references: [roomId], onDelete: Cascade)
  role       WorkshopMemberRole
  studentId  Int?
  teacherId  Int?
  nickname   String
  orderIndex Int
  isActive   Boolean             @default(true)
  joinedAt   DateTime            @default(now())
  contributions WorkshopContribution[]
  chats      WorkshopChatMessage[]
  votes      WorkshopContributionVote[]

  @@index([roomId])
}

model WorkshopContribution {
  contributionId Int                         @id @default(autoincrement())
  roomId         Int
  room           WorkshopRoom                @relation(fields: [roomId], references: [roomId], onDelete: Cascade)
  memberId       Int
  member         WorkshopMember              @relation(fields: [memberId], references: [memberId], onDelete: Cascade)
  orderIndex     Int
  content        String
  aiFeedback     Json?
  status         WorkshopContributionStatus @default(accepted)
  createdAt      DateTime                   @default(now())
  votes          WorkshopContributionVote[]

  @@index([roomId])
  @@index([memberId])
}

model WorkshopChatMessage {
  messageId Int               @id @default(autoincrement())
  roomId    Int
  room      WorkshopRoom      @relation(fields: [roomId], references: [roomId], onDelete: Cascade)
  memberId  Int?
  member    WorkshopMember?   @relation(fields: [memberId], references: [memberId], onDelete: SetNull)
  messageType WorkshopChatType @default(message)
  content   String
  createdAt DateTime           @default(now())

  @@index([roomId])
}

model WorkshopContributionVote {
  voteId         Int                @id @default(autoincrement())
  contributionId Int
  contribution   WorkshopContribution @relation(fields: [contributionId], references: [contributionId], onDelete: Cascade)
  memberId       Int
  member         WorkshopMember     @relation(fields: [memberId], references: [memberId], onDelete: Cascade)
  voteType       WorkshopVoteType
  createdAt      DateTime           @default(now())

  @@unique([contributionId, memberId])
}
